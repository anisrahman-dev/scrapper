name: Fetch latest news

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch news JSON (all sections)
        run: |
          python - <<'PY'
import json
import urllib.request
from datetime import datetime, timezone

SLUGS = {
    "latest-all": "latest",
    "bangladesh-all": "bangladesh",
    "politics-all": "politics",
    "world-all": "world",
    "business-all": "business",
    "sports-all": "sports",
    "entertainment-all": "entertainment",
    "chakri-all": "chakri",
}

def fetch(slug):
    url = f"https://www.prothomalo.com/api/v1/collections/{slug}"
    req = urllib.request.Request(
        url,
        headers={
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
            "Accept": "application/json",
        },
    )
    with urllib.request.urlopen(req, timeout=20) as resp:
        return json.load(resp)

def image_key(story):
    hero = story.get("hero-image-s3-key")
    if hero:
        return hero
    for card in story.get("cards", []):
        for el in card.get("story-elements", []):
            if el.get("type") == "image" and el.get("image-s3-key"):
                return el["image-s3-key"]
    return None

def extract_stories(data):
    stories = []
    for item in data.get("items", []):
        story = item.get("story")
        if not story:
            continue
        headline = story.get("headline")
        if isinstance(headline, list):
            headline = headline[0] if headline else None
        key = image_key(story)
        stories.append({
            "headline": headline,
            "url": story.get("url"),
            "image_s3_key": key,
            "image_url": f"https://images.prothomalo.com/{key}" if key else None,
        })
    return stories

sections = {}
for slug, name in SLUGS.items():
    data = fetch(slug)
    sections[name] = extract_stories(data)

fetched_at = datetime.now(timezone.utc).isoformat()

with open("news_sections.json", "w", encoding="utf-8") as f:
    json.dump({"fetched_at": fetched_at, "sections": sections}, f, ensure_ascii=False, indent=2)

with open("latest_news.json", "w", encoding="utf-8") as f:
    json.dump({"fetched_at": fetched_at, "stories": sections.get("latest", [])}, f, ensure_ascii=False, indent=2)

print("Wrote sections:", ", ".join(f"{k} ({len(v)} stories)" for k, v in sections.items()))
PY

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add latest_news.json news_sections.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: update news sections"
          git push
